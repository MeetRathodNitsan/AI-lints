name: AI Code Lint

on:
  pull_request:
    branches: ["master"]
  push:
    branches: ["master"]

jobs:
  ai-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -r requirements.txt
          .venv/bin/pip install requests fastapi uvicorn

      - name: Detect changed files
        id: changed_files
        run: |
          echo "Detecting changed files..."
          # Get PR or push changed files (Python/JS only)
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
                   | grep -E '\.py$|\.js$|\.ts$|\.java$' || true)
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Start AI Lint Server
        run: |
          nohup .venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Run AI Lint
        run: |
          echo "[DEBUG] Files to lint: ${{ steps.changed_files.outputs.files }}"
          if [ -z "${{ steps.changed_files.outputs.files }}" ]; then
            echo "⚠️ No files to lint. Skipping."
          else
            for file in ${{ steps.changed_files.outputs.files }}; do
              echo "[DEBUG] Linting $file"
              .venv/bin/python ai_lint.py "$file"
            done
          fi

      - name: Check Lint Results
        run: |
          echo "=== AI Lint Results ==="
          cat lint_results.txt || true

          if grep -q "BUG" lint_results.txt; then
            echo "❌ Bugs found. Blocking pipeline."
            exit 1
          elif grep -q "SUGGESTION" lint_results.txt; then
            echo "⚠️ Suggestions found. Please review."
          else
            echo "✅ No issues. Proceeding..."
          fi
